<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.hqy.cloud.message.tk.mapper.ImConversationMapper">

    <select id="queryGroupConversationMembers" resultType="com.hqy.cloud.message.tk.entity.ImConversation">
        SELECT id,user_id,contact_id
        FROM t_im_conversation
        WHERE contact_id = #{groupId} AND is_group = 1
    </select>

    <select id="queryPrivateConversations" resultType="com.hqy.cloud.message.tk.entity.ImConversation">
        SELECT id,user_id,contact_id,is_notice notice,is_group `group`,is_top top,last_remove_time lastRemoveTime
        FROM t_im_conversation WHERE
        (user_id = #{id} AND contact_id = #{contactId} AND is_group = 0 ) OR
        (user_id = #{contactId} AND contact_id = #{id} AND is_group = 0)
    </select>

    <resultMap id="ImChatDTOResultMap" type="com.hqy.cloud.message.bind.dto.ChatDTO">
        <association property="conversation" javaType="com.hqy.cloud.message.tk.entity.ImConversation">
            <result property="id" column="id"/>
            <result property="userId" column="userId"/>
            <result property="contactId" column="contactId"/>
            <result property="group" column="group"/>
            <result property="notice" column="notice"/>
            <result property="top" column="top"/>
            <result property="created" column="created"/>
            <result property="lastRemoveTime" column="lastRemoveTime"/>
            <result property="lastMessageType" column="lastMessageType"/>
            <result property="lastMessageContent" column="lastMessageContent"/>
            <result property="lastMessageTime" column="lastMessageTime"/>
            <result property="deleted" column="deleted"/>
        </association>
        <association property="friend" javaType="com.hqy.cloud.message.tk.entity.ImFriend">
            <result property="userId" column="friendId"/>
            <result property="remark" column="remark"/>
            <result property="index" column="index"/>
        </association>
        <association property="groupContact" javaType="com.hqy.cloud.message.bind.dto.GroupContactDTO">
            <result property="groupId" column="groupId"/>
            <result property="groupIndex" column="groupIndex"/>
            <result property="groupNotice" column="groupNotice"/>
            <result property="name" column="groupName"/>
            <result property="role" column="groupRole"/>
            <result property="groupAvatar" column="groupAvatar"/>
            <result property="creator" column="creator"/>
            <result property="groupInvite" column="groupInvite"/>
            <result property="created" column="groupCreated"/>
        </association>
    </resultMap>


    <select id="queryImChatDTO" resultMap="ImChatDTOResultMap">
        SELECT
            a.id,
            a.user_id userId,
            a.contact_id contactId,
            a.is_group `group`,
            a.is_notice `notice`,
            a.is_top top,
            a.last_remove_time `lastRemoveTime`,
            a.created,
            a.last_message_type `lastMessageType`,
            a.last_message_content `lastMessageContent`,
            a.last_message_time `lastMessageTime`,
            a.deleted `deleted`,
            f.user_id friendId,
            f.remark remark,
            f.index `index`,
            g.*
        FROM `t_im_conversation` a
            LEFT JOIN `t_im_friend` f ON a.`user_id` = f.`id` AND a.contact_id = f.user_id AND f.deleted = 0
            LEFT JOIN (
                SELECT
                    g.id groupId,
                    g.`index` groupIndex,
                    g.name groupName,
                    g.avatar groupAvatar,
                    g.creator,
                    g.is_invite groupInvite,
                    g.notice groupNotice,
                    g.created groupCreated,
                    m.role groupRole
                FROM `t_im_group` g LEFT JOIN t_im_group_member m on g.id = m.group_id
                WHERE m.user_id = #{userId}
            ) g ON a.`contact_id` = g.groupId
        WHERE a.`user_id` = #{userId}
    </select>

    <select id="queryConversationsByForwards" resultType="com.hqy.cloud.message.tk.entity.ImConversation">
        SELECT id,user_id,contact_id,is_group `group` FROM `t_im_conversation`
        WHERE
        <foreach collection="forwards" item="forward" separator="or" open="(" close=")">
        </foreach>
    </select>

    <insert id="insertOrUpdate" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_im_conversation
        (
            user_id,
            contact_id,
            is_group,
            is_notice,
            is_top,
            last_remove_time,
            last_message_type,
            last_message_content,
            last_message_time,
            deleted,
            created,
            updated
        ) VALUES
        <foreach collection="conversations" item="conversation" separator="," >
            (
             #{conversation.userId},
             #{conversation.contactId},
             #{conversation.group},
             #{conversation.notice},
             #{conversation.top},
             #{conversation.lastRemoveTime},
             #{conversation.lastMessageType},
             #{conversation.lastMessageContent},
             #{conversation.lastMessageTime},
             #{conversation.deleted},
             #{conversation.created},
             #{conversation.updated}
            )
        </foreach>
        ON DUPLICATE KEY UPDATE
        last_message_type = VALUES(last_message_type),
        last_message_content = VALUES(last_message_content),
        last_message_time = VALUES(last_message_time),
        deleted = VALUES(deleted),
        updated = VALUES(updated)
    </insert>

    <update id="deleteConversation">
        UPDATE t_im_conversation
        SET `deleted` = #{deleted}
        WHERE
        <if test="userId != null">
            user_id = #{userId} AND
        </if>
            contact_id = #{contactId} AND is_group = #{isGroup}
    </update>

    <update id="undoConversations">
        <foreach collection="conversations" item="conversation" separator=";">
            UPDATE t_im_conversation SET
                last_message_type = #{conversation.lastMessageType},
                last_message_content = #{conversation.lastMessageContent},
                last_message_time = #{conversation.lastMessageTime}
            WHERE user_id = #{conversation.userId} AND contact_id = #{conversation.contactId}
            AND is_group = #{conversation.group} AND last_message_time &lt;= #{conversation.lastMessageTime}
        </foreach>
    </update>

    <delete id="removeConversations">
        DELETE FROM t_im_conversation WHERE
        <foreach collection="conversations" item="conversation" separator="or">
            (user_id = #{conversation.userId} AND contact_id = #{conversation.contactId} AND is_group = #{conversation.group})
        </foreach>
    </delete>

</mapper>